/*
 Developer : Warren Seto
 Lab       : 3
 */

#include <stdio.h>
#include <sys/mman.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sys/types.h>
#include <unistd.h>
#include <sys/wait.h>
#include <stdlib.h>

#define INT_BUFFER_SIZE 4096
#define SHARED_MEMORY_NAME "Exercise4"

struct IntArray
{
    int size;
    int array[INT_BUFFER_SIZE];
};

int main(int argc, const char** argv)
{
    // Check if there is a input integer
    if (argc < 2)
    {
        // There is no input integer, just exit
        printf("No Value Entered. Exiting...\n");
        return 0;
    }
    
    // Parse input for the integer
    int input = atoi(argv[1]);
    
    // Setup the Shared Memory (if needed)
    const int memoryID = shm_open(SHARED_MEMORY_NAME, O_RDWR | O_CREAT, 0660);
    
    ftruncate(memoryID, sizeof(struct IntArray));
    
    // Both the child and the parent will have access to the data via a Struct
    struct IntArray* data = mmap(NULL, sizeof (struct IntArray), PROT_READ | PROT_WRITE, MAP_SHARED, memoryID, 0);
    
    // Fork and compute using the Collatz conjecture
    
    int processID = fork();
    
    if (processID) // Parent Process
    {
        wait(NULL);
        
        // Output the values generated by the child
        
        int count;
        for (count = 0; count < data->size; count++)
        {
            printf("%i ", data->array[count]);
        }
        
        printf("\n");
        
        // Remove the Shared Memory
        shm_unlink(SHARED_MEMORY_NAME);
    }
    
    else // Child Process
    {
        // Compute using the Collatz conjecture
        while (input > 1)
        {
            data->array[data->size++] = input;
            
            if (input % 2) {
                input = (3 * input) + 1;
            }
            
            else {
                input = input / 2;
            }
        }
        
        data->array[data->size++] = input;
        
        exit(0);
    }
    
    return 0;
}

